{{define "post"}}
    <script src='{{getStaticPath "/js/marked.min.js"}}'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.6/purify.min.js" integrity="sha512-YlctBG9PGZIhh9keoqI3eZkQM9T8QUbiBi7qNYAO/TUEo8jqWX5pLp5+x1cKRQDRzJ/lyGyJ9WUVNIRduxIIFw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>.mditor-mini textarea{min-height:100px} .emoji-list span{padding:3px;margin:1px;border:1px solid #ddd;display:inline-block;}</style>
    <script>function sendGetRequest(url){fetch(url)}</script>
    <main class="x-post-list flex flex-col gap-1">
        {{range  $index, $post := .posts}}
            <article class="x-post-item flex flex-row gap-2 lg:gap-4 p-2 flex-1 items-start bg-white dark:bg-slate-800" itemscope itemtype="https://schema.org/BlogPosting" itemid="{{$post.Pid}}">
                <meta itemprop="headline" content="{{$post.Title}}">
                <meta itemprop="dateModified" content="{{$post.UpdatedAt}}">
                <meta itemprop="description" content="{{truncate $post.Content 200}}">
                <meta itemprop="url" content="/p/{{$post.Pid}}">
                <meta itemprop="wordCount" content="{{len $post.Content}}">
                <meta itemprop="commentCount" content="{{$post.CommentCount}}">
                <meta itemprop="image" content="{{$post.User.Avatar}}">
                <meta itemprop="mainEntityOfPage" content="true">
                <div class="flex flex-col items-center cursor-pointer upVoteParent ">
                    <a class="text-coolGray  {{if $post.UpVoted}}text-red{{end}}"
                       href="{{if $post.UpVoted}}javascript:void(0);{{else}}/vote?id={{$post.Pid}}&action=u&type=POST{{end}}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M1 21h22L12 2"/>
                        </svg>
                    </a>
                    <div class="text-sm text-coolGray upVote">{{$post.UpVote}}</div>
                </div>
                <section class="flex flex-col flex-1 gap-1">
                    <header class="flex flex-row gap-2 items-center flex-wrap">

                        <h1 class="x-post-title text-sm fw-bold hover:text-gray dark:text-gray lg:max-w-4/5 text-[#06c] " itemprop="name" aria-label="æ–‡ç« æ ‡é¢˜">
                            {{ if eq $post.Type "ask"}}
                                <a href="/p/{{$post.Pid}}" aria-label="æŸ¥çœ‹æ–‡ç« è¯¦æƒ…">{{$post.Title}}</a>
                            {{else}}
                                <a href="{{$post.Link}}" target="_blank" onclick="sendGetRequest('/p/click/{{$post.Pid}}')" aria-label="è®¿é—®åŸæ–‡é“¾æ¥">{{$post.Title}}</a>
                            {{end}}
                        </h1>
                        {{if or (eq $.selected "/") (eq $.selected "history")}}
                            {{if gt $post.Top 0}}
                                <svg width="16px" height="16px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12">
                                    <g fill="#ef4444">
                                        <path d="M8.052 1.436a1.5 1.5 0 0 0-2.38.347L4.145 4.608l-2.33.928a.5.5 0 0 0-.169.818l1.647 1.647l-2.146 2.146l-.147.854l.854-.147L4 8.708l1.646 1.646a.5.5 0 0 0 .818-.168l.933-2.332l2.821-1.526a1.5 1.5 0 0 0 .347-2.38L8.052 1.436z"
                                              fill="#ef4444"></path>
                                    </g>
                                </svg>
                            {{end}}
                        {{end}}

                        <div class="flex flex-row gap-1 items-center text-xs ">
                            {{range $post.Tags}}
                                <div class="x-post-tag dark:text-white/70 {{.CssClass}} ">
                                    <a href="/t/{{.Name}}">{{.Name}}</a></div>
                            {{end}}
                            {{ if eq $post.Type "ask"}}
                                <div class=" border px-1.5 rounded bg-gray-2 b-solid  cursor-pointer ask bg-red text-white">
                                    <a href="/type/ask">è®¨è®º</a>
                                </div>
                            {{end}}
                            <div class="text-gray">
                                <a href="/d/{{$post.Domain}}" class="hover:text-hover">{{$post.Domain}}</a>
                            </div>
                        </div>
                    </header>
                    <div class="x-post-toolbar flex flex-row gap-2 items-center text-xs text-gray">
                        <img src="{{$post.User.Avatar}}" class="rounded w-5 h-5" alt="{{$post.User.Username}}çš„å¤´åƒ" referrerpolicy="no-referrer" rel="noopener" loading="lazy" onerror="this.onerror=null; this.src='/static/imgerr.png'"/>
                        <div itemprop="author" itemscope itemtype="https://schema.org/Person"><a class="cursor-pointer  hover:text-hover"
                                href="/u/profile/{{$post.User.ID}}" itemprop="url"><span itemprop="name">{{$post.User.Username}}</span></a></div>
                        <div class="when" itemprop="datePublished">{{$post.CreatedAt | timeAgo}}</div>
                        <div>|</div>
                        <div class="cursor-pointer  hover:text-hover">
                            <a href="/p/{{$post.Pid}}">
                                {{if gt $post.CommentCount 0 }}{{$post.CommentCount}}æ¡{{else}}å»{{end}}è¯„è®º
                            </a>
                        </div>
                        <div>|</div>
                        <div class="cursor-pointer  hover:text-hover">
                            <a href="/p/{{$post.Pid}}">{{$post.ClickVote}}ç‚¹å‡»</a>
                        </div>
                        <div>|</div>
                        <div class="cursor-pointer  hover:text-hover">
                            <a href="/p/{{$post.Pid}}">{{$post.CollectVote}}æ”¶è—</a>
                        </div>

                        {{ if $.userinfo}}
                            {{if or (eq $.userinfo.Role "admin") (eq $.userinfo.Username $post.User.Username) }}
                                <div>|</div>
                                <div class="cursor-pointer hover:text-red">
                                    <a href="/p/{{$post.Pid}}/edit">å»ç¼–è¾‘</a>
                                </div>
                            {{end}}
                        {{end}}
                    </div>
                    {{ if eq $.selected "detail"}}
                        {{ if eq $post.Type "link"}}
                            <br>
                            <aside class="dark:text-black" style="background-color: #eee;padding:5px 10px;border-radius: 3px;font-size: smaller;">ğŸ”— é˜…è¯»åŸæ–‡ï¼š<a href="{{$post.Link}}" target="_blank">{{$post.Link}}</a></aside>
                        {{end}}
                        <section class="mt-2 text-sm content dark:text-white/70" id="post-content" itemprop="articleBody">
                            {{$post.Content}}
                        </section>
                        <script>
                            function escapeHtml(html) {
                                return html
                                    .replace(/&/g, '&amp;')  // ä¸€å®šå…ˆè½¬ä¹‰ &
                                    .replace(/</g, '&lt;')
                                    .replace(/>/g, '&gt;');
                            }
                            const renderer = new marked.Renderer();
                            renderer.html = function(token) {
                                const html = typeof token === 'string' ? token : token.raw || '';
                                return escapeHtml(html);
                            };
                            marked.setOptions({
                                renderer,
                                gfm: true,
                                headerIds: true,
                                mangle: true
                            });
                            var html = marked.parse('{{$post.Content}}');
                            var safeHtml = DOMPurify.sanitize(html, {
                                ADD_TAGS: ['iframe'],
                                ADD_ATTR: ['allow', 'allowfullscreen', 'frameborder', 'scrolling']
                            });
                            // é“¾æ¥æ”¹ä¸ºæ–°æ ‡ç­¾é¡µæ‰“å¼€
                            safeHtml = safeHtml.replaceAll('<a href','<a target="_blank" class="dark:text-white/70" rel="noopener noreferrer" href');
                            safeHtml = safeHtml.replaceAll(
                                /<img([^>]*)>/g,
                                (match, group1) => {
                                    return `<img${group1} referrerpolicy="no-referrer" rel="noopener" loading="lazy" onerror="this.onerror=null; this.src=\'/static/imgerr.png\'">`;
                                }
                            );
                            document.getElementById('post-content').innerHTML = safeHtml;
                            document.addEventListener('DOMContentLoaded', function() {
                                const links = document.querySelectorAll('a[rel="noopener noreferrer"]');
                                links.forEach(link => {
                                    const href = link.getAttribute('href');
                                    if (href && !href.startsWith('/jump?url=')) {
                                        const newHref = '/jump?url=' + encodeURIComponent(href);
                                        link.setAttribute('href', newHref);
                                    }
                                });
                            });
                        </script>
                    {{end}}
                    {{if or (eq $.selected "approve") (eq $.selected "detail")}}
                    <br>
                    <div>
                        {{if eq $.selected "detail"}}
                        <div class="post-actions">
                        <a href="{{if $post.UpVoted}}javascript:alert('å·²ç»è¡¨è¿‡æ€å•¦ï¼');void(0);{{else}}/vote?id={{$post.Pid}}&action=u&type=POST{{end}}">
                            <button class="text-sm upVote like-button dark:text-white/70 {{if $post.UpVoted}}text-red{{end}}">ğŸ‘ {{if $post.UpVoted}}å·²{{end}}èµåŒ({{$post.UpVote}})</button>
                        </a>&nbsp;&nbsp;
                        <a href="{{if $post.CollectVoted}}/vote?id={{$post.Pid}}&action=cd&type=POST{{else}}/vote?id={{$post.Pid}}&action=c&type=POST{{end}}">
                            <button class="text-sm upVote like-button dark:text-white/70 {{if $post.CollectVoted}}text-red{{end}}">â˜… {{if $post.CollectVoted}}å·²{{end}}æ”¶è—({{$post.CollectVote}})</button>
                        </a>
                        </div>
                        {{end}}
                        {{ if and ($.userinfo) (eq $.userinfo.Role "admin")}}
                            {{ if or (eq $.selected "approve") (eq $.selected "detail")}}
                                <form action="/inspect" method="post">
                                    <div class="flex flex-col gap2 mt-2 text-xs" id="approve-form" data-post-id="{{$post.ID}}">
                                        <input name="post_id" type="hidden" value="{{$post.ID}}">
                                        <input name="inspect_type" type="hidden" value="POST">
                                        <div class="flex flex-row gap-1  items-center">
                                            <input type="radio" value="pass" id="pass-{{$index}}" data-index="{{$index}}" name="result">
                                            <label for="pass-{{$index}}">é€šè¿‡</label>
                                            <input type="radio" class="ml-2" value="reject" id="reject-{{$index}}"
                                                   data-index="{{$index}}" name="result">
                                            <label for="reject-{{$index}}">æ‹’ç»</label>
                                            <button class="btn text-xs ml-2" type="submit">å®¡æ ¸</button>
                                        </div>
                                        <div class="hidden" id="reason-{{$index}}">
                                            <textarea name="reason" class="input w-full" placeholder="å¡«å†™æ‹’ç»ç†ç”±"></textarea>
                                        </div>
                                    </div>
                                </form>
                            {{end}}
                        {{end}}
                    </div>
                    {{end}}

                    {{ if and (eq $.selected "detail") (gt (len $.relatedPosts) 0)}}
                    <aside class="mt-8 mb-4">
                        <h3 class="text-lg font-bold mb-4 dark:text-white/70" aria-label="ç›¸å…³æ–‡ç« æ¨è">âœ¨ è¿™å‡ ç¯‡ä¹Ÿä¸èµ–ï¼Œä½ å¯èƒ½è¿˜æƒ³çœ‹çœ‹</h3>
                        <div class="flex flex-col gap-3">
                            {{range $.relatedPosts}}
                            <div class="flex flex-row gap-2 items-start" itemscope itemtype="https://schema.org/Article">
                                <div class="text-sm text-coolGray">Â·</div>
                                <div class="flex flex-col flex-1">
                                    <a href="/p/{{.Pid}}" class="text-sm hover:text-hover dark:text-white/70" itemprop="headline">{{.Title}}</a>
                                    <div class="flex flex-row gap-2 items-center text-xs text-gray mt-1">
                                        <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="name">{{.User.Username}}</span></span>
                                        <span>Â·</span>
                                        <time itemprop="datePublished" datetime="{{.CreatedAt}}">{{.CreatedAt | timeAgo}}</time>
                                        <span>Â·</span>
                                        <meta itemprop="commentCount" content="{{.CommentCount}}">
                                        <span>{{.CommentCount}}è¯„è®º</span>
                                    </div>
                                </div>
                            </div>
                            {{end}}
                        </div>
                    </aside>
                    {{end}}

                    {{ if eq $.selected "detail" }}
                        <br>
                        <h3 class="text-lg font-bold mb-4 dark:text-white/70" aria-label="è¯„è®º">ğŸ«µ æ¥å•Šï¼Œè¯´ç‚¹æœ‰ç”¨çš„åºŸè¯!</h3>
                        <form method="post" action="/p/comment" id="comment_form">
                            <input type="hidden" name="post_pid" value="{{$post.Pid}}">
                            <input type="hidden" name="post_id" value="{{$post.ID}}">
                            <input type="hidden" name="parent_comment_id" value="">
                            <div class="flex flex-col gap-2 mt-4">
                                <textarea id="md_editor" name="content" class="input" rows="5" placeholder="è¯„è®ºä¹Ÿæ˜¯å†…å®¹çš„ä¸€éƒ¨åˆ†ï¼Œä½ çš„é«˜è§æ­£åœ¨è¢«æœŸå¾…ï¼"></textarea>
                                <div id="emoji-list-0" class="emoji-list" style="display: none"></div>
                                <div class="flex flex-row gap2 mt-2 dark:text-white">
                                    {{if $.login}}
                                        <button class="btn" type="submit">å‘è¡¨è¯„è®º</button>
                                    {{else}}
                                        <a href="/u/login?redirect=/p/{{$post.Pid}}"
                                           class="text-sm hover:text-hover underline fw700">ç™»å½•ä¸€ä¸‹ï¼Œä¸ç„¶ä½ è¯´è¯æˆ‘å¬ä¸åˆ°ï¼</a>
                                    {{end}}
                                </div>
                            </div>
                        </form>
                            <script>sendGetRequest('/p/click/{{$post.Pid}}')</script>
                    {{end}}

                    {{if and (gt (len $post.Comments) 0) (not (eq $.selected "mine"))}}
                        <div id="comment-tree" class="mt-4 relative" itemprop="comment">
                            {{range $post.Comments}}
                                {{template "comment" dict "Comment" . "Post" $post "Login" $.login "Userinfo" $.userinfo}}
                            {{end}}
                        </div>
                    {{end}}
                    <script>
                        function changeClass(img) {
                            if (img.classList.contains("zoomed")) {
                                img.classList.remove("zoomed");
                            } else {
                                img.classList.add("zoomed");
                            }
                        }
                    </script>
                </section>
            </article>
        {{end}}
        {{ if eq $.selected "detail" }}
        <script src='{{getStaticPath "/js/mditor.js"}}'></script>
        <script type="text/javascript">
            //è·å–textarea domå¯¹è±¡
            var ele_textarea = document.getElementById('md_editor');
            //å®ä¾‹åŒ–Mditor
            var editor = new mditor(ele_textarea,{
                //è‡ªå®šä¹‰æ˜¾ç¤ºæ•ˆæœclass
                previewClass : 'content'
            });
            {{if not $.login}}
            editor.insert("ğŸ¤– å…ˆä¸Šå·ï¼Œå†ä¸Šå˜´ï¼");
            {{end}}
        </script>
        {{end}}
    </main>
{{end}}
